<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * {
      box-sizing: border-box;
      border: none;
      padding: 0;
      margin: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      padding: 0;
      margin: 0;
    }

    body {
      /*box-shadow: 0 0 10px #719ECE;*/
      /*border: 1px solid gray;*/
      display: grid;
      overflow: hidden;
      grid-template-rows: 32px minmax(0,1fr)
    }

    header {
      width: 100%;
      height: 32px;
      display: grid;
      background-color: #50ffc4;
      grid-template-columns: minmax(0,1fr) auto;
    }

      header, header * {
        -webkit-user-select: none;
        -webkit-user-drag: none;
      }


    #window-handle {
      width: 100%;
      height: 100%;
      background-color: transparent;
      -webkit-user-select: none;
      -webkit-app-region: drag;
    }

    #window-toolbar {
      height: 100%;
      background-color: transparent;
    }

      #window-toolbar > * {
        width: 32px;
        height: 32px;
      }

    button {
      position: relative;
      background-color: transparent;
      border: none;
    }

      button:focus {
        outline: none;
        box-shadow: none;
      }

        button:focus::after {
          content: '';
          display: block;
          position: absolute;
          left: 0;
          right: 0;
          top: 0;
          bottom: 0;
          border: 2px solid black;
        }

    #content {
      width: 100%;
      height: 100%;
      padding: 6px;
      background-color: #9fffc1
    }

      #content > textarea {
        /*white-space: pre;*/
        width: 100%;
        height: 100%;
        resize: none;
        background-color: transparent;
      }

        #content > textarea:focus {
          /*border: 1px solid gray;*/
          outline: none;
        }
  </style>
</head>

<body>
  <header>
    <div id="window-handle"></div>
    <div id="window-toolbar">
      <button onclick="close_window()">
        <img src="exit-icon.png" style="width:100%;height:100%; object-fit:contain" />
      </button>
    </div>
  </header>
  <section id="content">
    <textarea onchange="save()"></textarea>
  </section>

  <script>
    const localforage = require('localforage').createInstance({ name: 'notes' })
    const { remote } = require('electron')
    const id = remote.getCurrentWindow().noteid
    /**@type{HTMLTextAreaElement} */
    const textContentElement = document.querySelector('#content textarea')

    load()

    async function load() {
      const default_config = {
        bounds: remote.getCurrentWindow().getBounds(),
        content: '',
      }

      let memory = await localforage.getItem(id).catch(err => {
        console.log(err)
        return {}
      })

      let config = { ...default_config, ...memory }

      console.log('default_config', default_config)
      console.log('memory', memory)
      console.log('config', config)

      textContentElement.value = config.content
      remote.getCurrentWindow().setBounds(config.bounds)
      remote.getCurrentWindow().show()
      console.log(`note ${id} opened`)
    }

    remote.getCurrentWindow().addListener('moved', save)
    remote.getCurrentWindow().addListener('resize', save)

    function save() {
      localforage.setItem(id, {
        bounds: remote.getCurrentWindow().getBounds(),
        content: textContentElement.value
      })
      console.log(`note ${id} saved`)
    }

    function close_window() {
      remote.getCurrentWindow().close()
    }

  </script>
</body>
</html>
