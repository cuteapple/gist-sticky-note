<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        #new-note {
            width: 100%;
            padding: 6px;
        }

        #list-of-notes {
            width: 100%;
            padding: 6px;
        }

        .note-index {
            width: 100%;
            border: 3px solid lightblue;
            min-height: 3em;
            max-height: 6em;
            margin: 3px 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
    <title>Note List</title>
</head>
<body>
    <button id="new-note" onclick="new_note()">new note</button>
    <div id="list-of-notes">
    </div>

    <script>
        const { remote, ipcRenderer } = require('electron')
        const localforage = require('localforage')
        const metastorage = localforage.createInstance({ name: 'meta' })
        const notestorage = localforage.createInstance({ name: 'notes' })

        {
            (async () => {
                let open_notes = new Set(await metastorage.getItem('z-order') || [])
                open_notes = (open_notes)
                let all_notes = await notestorage.keys() || []

                for(let id of open_notes) {
                    open_note(id)
                    document.getElementById('list-of-notes').append(await createIndexElement(id))
                }

                for(let id of all_notes) {
                    if(open_notes.has(id)) continue;
                    document.getElementById('list-of-notes').append(await createIndexElement(id))
                }
            })()
        }

        async function createIndexElement(id) {
            let data = await notestorage.getItem(id)

            let content = document.createElement('section')
            content.innerText = data.content
            content.classList.add('note-index')

            content.addEventListener('click', () => open_note(id))

            return content
        }

        function open_note(noteid) {
            ipcRenderer.send('open-note', noteid)
        }

        function new_note() {
            let id = '' + Date.now() + '.' + Math.random() * 100000
            open_note(id)
        }

        ipcRenderer.on('order-changed', (sender, notes_order) => {
            metastorage.setItem('z-order', notes_order)
        })
    </script>
</body>
</html>
